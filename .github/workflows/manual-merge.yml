name: Manual Merge Branch to main

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to merge into main'
        required: true
        default: 'fix/auto-checks'

jobs:
  create-and-merge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create and merge PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = inputs.branch;

            // Check for existing open PR from branch to main
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${branch}`,
              base: "main",
              state: "open",
            });

            let prNumber;
            if (prs.length > 0) {
              prNumber = prs[0].number;
              core.info(`Found existing PR #${prNumber} from ${branch} -> main`);
            } else {
              // Create PR
              const { data: pr } = await github.rest.pulls.create({
                owner,
                repo,
                title: `Merge ${branch} into main (automated)`,
                head: branch,
                base: "main",
                body: "Automated PR created by manual-merge workflow",
              });
              prNumber = pr.number;
              core.info(`Created PR #${prNumber}`);
            }

            // Attempt to merge the PR
            try {
              const { data: mergeResult } = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: prNumber,
                merge_method: "merge",
              });
              core.info(`Merged PR #${prNumber}: ${mergeResult.message}`);
            } catch (err) {
              core.setFailed(`Failed to merge PR #${prNumber}: ${err.message}`);
            }

